name: Release tarball on tag
concurrency: 
  group: workflow-tarball
  cancel-in-progress: false
on:
  push:
    tags:
      - 'rel-*'   # or 'v*' 

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
#---------------------------------------------------
      - name: Compute tag + filenames
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"          # rel-1.2.3
          NAME="xymon-${TAG#rel-}"          # 1.2.3
          ASSET="${NAME}.tar.gz"      # xymon-1.2.3.tar.gz

          echo "tag=${TAG}"   >> "${GITHUB_OUTPUT}"
          echo "name=${NAME}" >> "${GITHUB_OUTPUT}"
          echo "asset=${ASSET}" >> "${GITHUB_OUTPUT}"
#---------------------------------------------------
      - name: Create tar.gz named after tag (folder == tag)
        shell: bash
        run: |
          set -euo pipefail
          PREFIX="${{ steps.vars.outputs.name }}/"
          git archive \
            --format=tar \
            --prefix="${PREFIX}" \
            --exclude='.github/*' \
            "${{ steps.vars.outputs.tag }}" \
          | gzip -9 > "${{ steps.vars.outputs.asset }}"
#---------------------------------------------------
      - name: Create GitHub Release and upload tarball
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: ${{ steps.vars.outputs.tag }}
          generate_release_notes: "true"
          files: |
            ${{ steps.vars.outputs.asset }}


